<html>
<head>
    <title>Canvas Driver</title>


<script>

function getRandomInt(min, max) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
}

function changeSpanText(id, spanText){
	var theSpan = document.getElementById(id);
	if ('textContent' in theSpan) {
		theSpan.textContent = spanText;
	} else {
		theSpan.innerText = spanText;
	}
}


function getTrackLine(left, roadWidth, trackWidth){

    var track="";

    for(var i=0; i < left; i++){
        track+="*";
    }

    // create the width
    for(var i=0; i < roadWidth; i++){
        track += " ";
    }

    for(var i=left+roadWidth; i < trackWidth; i++){
      track+="*";
    }

    return track;
}

document.onkeydown = function onkeydown(event) {

	// console.log(event.keyCode);
  var LEFT_KEY = 37;
  var RIGHT_KEY = 39;
  var UP_KEY = 38;
  var DOWN_KEY = 40;
  var SPACE_KEY = 32;
  var ENTER_KEY = 13;

	if(event.keyCode==LEFT_KEY){
		carPosition-=1;
	}

	if(event.keyCode==RIGHT_KEY){
		carPosition+=1;
	}

	if(event.keyCode==SPACE_KEY){
		startGame=true;
	}

  if(event.keyCode==ENTER_KEY){
    promptForValues=true;
  }

}

var track = new Array();

function showInfo(message){
  changeSpanText('info', message);
}

function instructions(){
	//document.getElementById('gameboard').style.display = 'none';
	if(startGame){
    showInfo("Drive Safely");
		window.clearInterval(theTimer);
		document.getElementById('instructions').style.display = 'none';
		document.getElementById('gameboard').style.display = 'block';
		setValuesToStartingValues();

    // set level prototype
    setLevelElement = document.getElementById('setLevel');
    if(setLevelElement.style.display != 'none'){
        var setLevelTo = parseInt(setLevelElement.value);
        setDifficultyLevel(setLevelTo);
    }

    createTrack();

		theTimer = window.setInterval(playGame, millisecondsBetweenScrolls);
		startGame=false;
	}
}

function createTrack(){

    calculateFontSizeBasedOnCanvas()

    track = new Array();
    for(var trackLine=0;trackLine<maxTrackLines;trackLine++){
        track.push(getTrackLine(posOfLeftOfTrack, widthOfTrack, maxWidthOfArena));
    }
}

function calculateFontSizeBasedOnCanvas(){
    var canvas = document.getElementById("gamedisplay");
    if(canvas.getContext){
        var context2d = canvas.getContext("2d");

        // calculate a fontsize that fits canvas
        fontSize = Math.floor(context2d.canvas.height/maxTrackLines);
        context2d.font = fontSize + "px courier";
        while((context2d.measureText("*").width * maxWidthOfArena)>context2d.canvas.width){
          fontSize--;
          context2d.font = fontSize + "px courier";
        }
        fontWidth = context2d.measureText("*").width;
        // how many lines fit into the canvas?
        while(maxTrackLines*fontSize<context2d.canvas.height){
          maxTrackLines++;
        }
        maxTrackLines--;
    }

    carLine = Math.floor((maxTrackLines/2)/2);

}

function drawTrack(){
  var canvas = document.getElementById("gamedisplay");

  if(canvas.getContext){
      var context2d = canvas.getContext("2d");

      context2d.clearRect(0,0,context2d.canvas.width, context2d.canvas.height);
      context2d.fillStyle = "#FFFFFF";
      context2d.fillRect(0,0,context2d.canvas.width, context2d.canvas.height);
      context2d.fillStyle = "#000000";
      
      for(var yline=0;yline<maxTrackLines;yline++){
          context2d.fillText(track[yline],0,yline*fontSize);
      }
  }

}

function drawCar(carLine,carPosition){
    var canvas = document.getElementById("gamedisplay");

    if(canvas.getContext){
        var context2d = canvas.getContext("2d");
        context2d.fillStyle = "#000000";
        context2d.fillText("V",carPosition*fontWidth,carLine*fontSize);
    }
}

function drawCrashedCar(carLine,carPosition){
    var canvas = document.getElementById("gamedisplay");

    if(canvas.getContext){
        var context2d = canvas.getContext("2d");
        context2d.fillStyle = "#000000";
        context2d.fillText("X",carPosition*fontWidth,carLine*fontSize);
    }
}

function scrollTrack(nextLine){
    track.shift();
    track.push(nextLine);
}



function playGame(){

  // calculate points etc.
  distanceTravelled++;
  points=distanceTravelled*10;
  points+=bonuspoints;
  changeSpanText('thePoints', points);
  changeSpanText('theSpeed', 50 + Math.floor(500-millisecondsBetweenScrolls)); ///500);
  changeSpanText('lives', lives);
  changeSpanText('health', currenthealth);

  scroll()


  // change track width
  changeTrackWidth();


  displayTheTrackToTheConsole();
  adjustTheTrackForRoadWeaving();

	if(hasCrashed){
    endGame();
	}
}

function scroll(){
    // change speed
    distanceToNextSpeedChange--;
    //console.log("distance to speed change " + distanceToNextSpeedChange);
  if(distanceToNextSpeedChange<0){
      millisecondsBetweenScrolls-=currentAcceleration;
      //console.log("speed " + millisecondsBetweenScrolls + " and max " + maxSpeedMillis);

      if(millisecondsBetweenScrolls<maxSpeedMillis){
        millisecondsBetweenScrolls=maxSpeedMillis;
      }

      window.clearInterval(theTimer);
      theTimer = window.setInterval(playGame, millisecondsBetweenScrolls);

      changeSpeed();

  }
}

function getNewLevelDetails(aDistance){

  for(var changeIndex=0; changeIndex<levelSettings.changes.length; changeIndex++){
    var changes = levelSettings.changes[changeIndex];
    if(aDistance>=changes.start && aDistance<=changes.end){
      return changes;
    }
  }

  return levelSettings.defaultChanges;

}

function changeSpeed(){

  //{start:0, end:100, tillSpeedChange:5, accel:100, widthChangeEvery:1, minWidth:12, maxWidth:100, maxSpeedMillisChange:null, milliSpeedLimit=500},



  if(distanceTravelled > currentLevelChanges.end){
    currentLevelChanges = getNewLevelDetails(distanceTravelled);
  }

  

  if(distanceToNextSpeedChange<0){

    //console.log(currentLevelChanges);



    if(currentLevelChanges.tillSpeedChange!=null){

      distanceToNextSpeedChange=currentLevelChanges.tillSpeedChange;

      if(currentLevelChanges.accel!=null){
        currentAcceleration=currentLevelChanges.accel;
        //console.log("accel: " + currentAcceleration);
      }
      if(currentLevelChanges.widthChangeEvery!=null){
        trackWidthChangeEvery=currentLevelChanges.widthChangeEvery;
        //console.log("trackWidthChangeEvery: " + trackWidthChangeEvery);
      }      

      if(currentLevelChanges.maxSpeedMillisChange!=null){
        maxSpeedMillis-=currentLevelChanges.maxSpeedMillisChange;
        //console.log("maxSpeedMillis: " + maxSpeedMillis);
      }
      if(currentLevelChanges.milliSpeedLimit!=null){       
          maxSpeedMillis=currentLevelChanges.milliSpeedLimit;
         // console.log("speed limit changed maxSpeedMillis: " + maxSpeedMillis);
      }
    }
    if(currentLevelChanges.minWidth!=null){
        minWidthOfTrack=currentLevelChanges.minWidth;
    }
    if(currentLevelChanges.maxWidth!=null){
      if(currentLevelChanges.maxWidth<maxWidthOfArena){
        maxWidthOfTrack=currentLevelChanges.maxWidth;
      }
    }
  }
}


function changeTrackWidth(){
  //console.log(trackWidthChangeEvery)

  if(distanceTravelled%trackWidthChangeEvery==0){
    
      //console.log("track change " + widthOfTrack)
      if(widthOfTrack < minWidthOfTrack){
        // too small bring withing width
        widthOfTrack++;
        return;
      }
      if(widthOfTrack > maxWidthOfTrack){
        // too big get width back within tolerances
        widthOfTrack--;
        return;
      }

      // decide if we make bigger or smaller
      var sizeOptions = [];
      sizeOptions.push(0); // stay same size
      for(var addItem=widthOfTrack;addItem<maxWidthOfTrack;addItem++){
        sizeOptions.push(1); // increase
      }
      for(var addItem=minWidthOfTrack;addItem<widthOfTrack;addItem++){
        sizeOptions.push(-1); // decrease
      }

      var sizeBy = Math.floor(Math.random()*sizeOptions.length);
      //console.log("choose option " + sizeBy);
      //console.log("widen " + sizeOptions[sizeBy]);
      widthOfTrack+=sizeOptions[sizeBy];
  }
}

function setDifficultyLevel(theLevel){

  bonuspoints = theLevel*1000;

  var levels =[{s:500,w:40},
               {s:450,w:35},
               {s:400,w:30},
               {s:350,w:25},
               {s:300,w:20},
               {s:250,w:15},
               {s:200,w:10}
            ];

  var setToLevel=0;
  if(theLevel>=0 && theLevel<levels.length){
    setToLevel=theLevel;
  }

  if(theLevel>=levels.length){
    setToLevel=levels.length-1;
  }

  millisecondsBetweenScrolls=levels[setToLevel].s;
  widthOfTrack=levels[setToLevel].w;
  carPosition = posOfLeftOfTrack + Math.floor(widthOfTrack/2);
}

function endGame(){
  showInfo("!!GAME OVER!! You Crashed! You Scored " + points);
  startGame=false;
  window.clearInterval(theTimer);
  document.getElementById('instructions').style.display = 'block';
  //document.getElementById('gameboard').style.display = 'none';
  theTimer = window.setInterval(instructions, millisecondsBetweenScrolls);

}



function advanceCar(){
  drawCar(carLine,carPosition);
}

function displayTheTrackToTheConsole(){

  

  var nextLine = getTrackLine(posOfLeftOfTrack, widthOfTrack, maxWidthOfArena);

  scrollTrack(nextLine);

  drawTrack();

  advanceCar();
  

  // get track from array
  var trackDisplay = track[carLine];

  var trackArray = trackDisplay.split("");
  var carSpace = trackArray[carPosition];

  // use array above instead of string manipulationg - seems simpler
  //var leftOfTrack = trackDisplay.substring(0,carPosition);
  //var carSpace = trackDisplay.substr(carPosition, 1);
  //var rightOfTrack = trackDisplay.slice(carPosition);

  if(checkForCrash(carSpace)){
    carDisplay="X";
    drawCrashedCar(carLine, carPosition);
  }

  // add car to the track
  //trackDisplay = leftOfTrack + carDisplay + rightOfTrack;
  trackArray[carPosition] = carDisplay;

  trackDisplay = trackArray.join("");

  // enable for console driver - 2 in 1 game mega bonus - double winner you are
  //console.log(trackDisplay);
  

}

function centerCar(){
  carPosition = track[carLine].indexOf(" ")+
                Math.floor(
                    (track[carLine].lastIndexOf(" ")-track[carLine].indexOf(" ")
                    )/2);
}

function bumpCarBackOnToRoad(){
  var leftSide = track[carLine].indexOf(" ");
  var rightSide = track[carLine].lastIndexOf(" ");
  if(carPosition<=leftSide){
    carPosition=leftSide+1;
  }else{
    carPosition=rightSide-1;
  }
}


function checkForCrash(carSpace){
    //if(carSpace != " "){  // are you on a road?
    var justLostALife = false;

  if(carSpace == "*"){ // have you hit a wall?

    currenthealth--;
    if(currenthealth<1){
      lives--;
      justLostALife = true;
      currenthealth=maxhealth;
    }

    
    if(lives<1){
      // deaded
      hasCrashed=true;
    }else{

      // second chance
      showInfo("OUCH - be careful - Health: " + currenthealth + " - Lives left: " + lives);

      if(justLostALife){
        millisecondsBetweenScrolls*=3;
        if(millisecondsBetweenScrolls>500){
          millisecondsBetweenScrolls=500;
        }
        centerCar()
      }else{
        // bump car on to road
        bumpCarBackOnToRoad();
      }
    }

    
    return true;
  }
  return false;
}


function adjustTheTrackForRoadWeaving(){
  var leftNudge = getRandomInt(-1, 1);

  posOfLeftOfTrack += leftNudge;
  if(posOfLeftOfTrack<1){
    posOfLeftOfTrack=1;
  }
  if((posOfLeftOfTrack+widthOfTrack) > maxWidthOfArena){
    posOfLeftOfTrack = maxWidthOfArena - widthOfTrack - 1;
  }
}

function setValuesToStartingValues(){


  levelSettings = { changes:[
                      {start:0, end:40, tillSpeedChange:1, accel:100, widthChangeEvery:1, minWidth:15, maxWidth:20, maxSpeedMillisChange:null, milliSpeedLimit:100},
                      {start:40, end:80, tillSpeedChange:4, accel:5, widthChangeEvery:1, minWidth:3, maxWidth:7, maxSpeedMillisChange:null, milliSpeedLimit:300},
                      {start:81, end:100, tillSpeedChange:4, accel:5, widthChangeEvery:1, minWidth:3, maxWidth:10, maxSpeedMillisChange:null, milliSpeedLimit:250},
                      {start:101, end:150, tillSpeedChange:3, accel:5, widthChangeEvery:1, minWidth:3, maxWidth:7, maxSpeedMillisChange:null, milliSpeedLimit:200},
                      {start:151, end:200, tillSpeedChange:3, accel:5, widthChangeEvery:2, minWidth:5, maxWidth:10, maxSpeedMillisChange:null, milliSpeedLimit:180},
                      {start:201, end:250, tillSpeedChange:3, accel:10, widthChangeEvery:3, minWidth:4, maxWidth:8, maxSpeedMillisChange:null, milliSpeedLimit:190},
                      {start:251, end:300, tillSpeedChange:3, accel:10, widthChangeEvery:2, minWidth:7, maxWidth:13, maxSpeedMillisChange:null, milliSpeedLimit:170},
                      {start:301, end:350, tillSpeedChange:3, accel:10, widthChangeEvery:2, minWidth:5, maxWidth:9, maxSpeedMillisChange:10, milliSpeedLimit:160},
                      {start:351, end:400, tillSpeedChange:3, accel:10, widthChangeEvery:1, minWidth:5, maxWidth:8, maxSpeedMillisChange:10, milliSpeedLimit:150},
                      {start:401, end:500, tillSpeedChange:3, accel:15, widthChangeEvery:2, minWidth:5, maxWidth:6, maxSpeedMillisChange:null, milliSpeedLimit:150},
                      {start:501, end:600, tillSpeedChange:2, accel:20, widthChangeEvery:3, minWidth:3, maxWidth:6, maxSpeedMillisChange:null, milliSpeedLimit:125},
                      {start:601, end:700, tillSpeedChange:2, accel:30, widthChangeEvery:2, minWidth:3, maxWidth:5, maxSpeedMillisChange:null, milliSpeedLimit:100},
                      {start:701, end:800, tillSpeedChange:2, accel:40, widthChangeEvery:4, minWidth:3, maxWidth:20, maxSpeedMillisChange:null, milliSpeedLimit:50},
                      {start:801, end:900, tillSpeedChange:2, accel:40, widthChangeEvery:2, minWidth:2, maxWidth:20, maxSpeedMillisChange:null, milliSpeedLimit:40},
                      {start:901, end:1000, tillSpeedChange:2, accel:40, widthChangeEvery:3, minWidth:1, maxWidth:10, maxSpeedMillisChange:null, milliSpeedLimit:30},
                      {start:1001, end:2000, tillSpeedChange:2, accel:40, widthChangeEvery:3, minWidth:1, maxWidth:20, maxSpeedMillisChange:null, milliSpeedLimit:20},
                    ],
                    defaultChanges: {start:0, end:0, tillSpeedChange:5, accel:40, widthChangeEvery:1, minWidth:1, maxWidth:5, maxSpeedMillisChange:10, milliSpeedLimit:20}
                  };

   currentLevelChanges = levelSettings.changes[0];

   posOfLeftOfTrack=1;
   maxWidthOfArena=defaultMaxWidthOfTrack;
   widthOfTrack=maxWidthOfArena-2;
   maxWidthOfTrack=widthOfTrack;
   minWidthOfTrack=4;

   trackWidthChangeEvery=5;
   currentAcceleration=50;
   lives = 3;
   maxhealth = 4;
   currenthealth = 4;

   points=0;
   bonuspoints=0;
   startGame = false;
   trackString = " - ";
   carDisplay = "V";
   hasCrashed = false;
   millisecondsBetweenScrolls=500;
   distanceTravelled=0;
   distanceToNextSpeedChange=5;
   speedChanges=0;
   maxSpeedMillis=100;
   maxWidthOfTrackIncrement=3;

   maxTrackLines=20;

   if(promptForValues){
      var promptedValue = window.prompt("Enter Max Arena Width",maxWidthOfArena);
      if(promptedValue!=null){
        maxWidthOfArena = parseInt(promptedValue);
      }

      promptedValue = window.prompt("Enter Start Width of Track",widthOfTrack);
      if(promptedValue!=null){
        widthOfTrack = parseInt(promptedValue);
      }

      promptedValue = window.prompt("Enter initial milliseconds between scrolls (speed - high is slower)",millisecondsBetweenScrolls);
      if(promptedValue!=null){
        millisecondsBetweenScrolls = parseInt(millisecondsBetweenScrolls);
      }

      promptForValues=false;
   }

   posOfLeftOfTrack = getRandomInt(1,(maxWidthOfArena/2)-(widthOfTrack/2)-1);
   carPosition = posOfLeftOfTrack + Math.floor(widthOfTrack/2);

}


  var defaultMaxWidthOfTrack=60;

  var distanceTravelled, distanceToNextSpeedChange, speedChanges, fontSize, fontWidth;
  var levelSettings, currentLevelChanges;
  var carLine; // car position line display
  var posOfLeftOfTrack=1;
  var maxWidthOfArena=60;
  var widthOfTrack=maxWidthOfArena-6;
  var maxWidthOfTrack=widthOfTrack;
  var minWidthOfTrack=8;
  var trackWidthChangeEvery=5;
  var currentAcceleration=50;
  var maxTrackLines=20;
  var lives = 3;
  var maxhealth = 4;
  var currenthealth = 4;

  var carPosition = posOfLeftOfTrack + (widthOfTrack/2);
  var points=0;
  var bonuspoints=0;
  var startGame = false;
  var promptForValues=false;
  // build a string and display to the console
  // randomly shift track left or right

  var trackString = " - ";

  var carDisplay = "V";
  var hasCrashed = false;

  // initially show the instructions
  var millisecondsBetweenScrolls=500;
  var maxSpeedMillis=50;
  var theTimer = window.setInterval(instructions, millisecondsBetweenScrolls);
  var maxWidthOfTrackIncrement=3;



</script>

</head>
<body>

<h1>Canvas Driver</h1>

  <div id="instructions">
  	<h1>Instructions</h1>
  	<p>Use left and Right to keep your car 'V' on the track.
       Hit a wall '*' and you will lose health. You only have 4 health.
       If you lose all your health, you explode "X". Each Time you
       explode you lose a life. You only have 3 lives.</p>
  	<p><strong>Press space to start game</strong></p>
    <!-- prototype for set start level difficulty -->
    <input id="setLevel" style="display:none" value="1" />
  </div>

  <!-- todo: add some defaults and debugging here to make tweaking gameplay easier -->

  <div id="gameboard">
  	<p>
      Points: <span id='thePoints'></span>
      Speed: <span id='theSpeed'></span>
      Health: <span id='health'></span>
      Lives: <span id='lives'></span>
    </p>
    <canvas id="gamedisplay" width="500" height="500"></canvas>
  </div>

  <h2>Info: <span id='info'></span></h2>

</body>
</html>
