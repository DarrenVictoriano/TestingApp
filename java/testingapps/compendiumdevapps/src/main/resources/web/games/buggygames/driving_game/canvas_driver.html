<html>
<head>
    <title>Canvas Driver</title>


<script>

function getRandomInt(min, max) {
    return Math.floor(Math.random() * (max - min + 1)) + min;
}

function changeSpanText(id, spanText){
	var theSpan = document.getElementById(id);
	if ('textContent' in theSpan) {
		theSpan.textContent = spanText;
	} else {
		theSpan.innerText = spanText;
	}
}


function getTrackLine(left, roadWidth, trackWidth){

    var track="";

    for(var i=0; i < left; i++){
        track+="*";
    }

    // create the width
    for(var i=0; i < roadWidth; i++){
        track += " ";
    }

    for(var i=left+roadWidth; i < trackWidth; i++){
      track+="*";
    }

    return track;
}

document.onkeydown = function onkeydown(event) {

	// console.log(event.keyCode);
  var LEFT_KEY = 37;
  var RIGHT_KEY = 39;
  var UP_KEY = 38;
  var DOWN_KEY = 40;
  var SPACE_KEY = 32;
  var ENTER_KEY = 13;

	if(event.keyCode==LEFT_KEY){
		carPosition-=1;
	}

	if(event.keyCode==RIGHT_KEY){
		carPosition+=1;
	}

	if(event.keyCode==SPACE_KEY){
		startGame=true;
	}

  if(event.keyCode==ENTER_KEY){
    promptForValues=true;
  }

}

var track = new Array();

function showInfo(message){
  changeSpanText('info', message);
}

function instructions(){
	//document.getElementById('gameboard').style.display = 'none';
	if(startGame){
    showInfo("Drive Safely");
		window.clearInterval(theTimer);
		document.getElementById('instructions').style.display = 'none';
		document.getElementById('gameboard').style.display = 'block';
		setValuesToStartingValues();

    // set level prototype
    setLevelElement = document.getElementById('setLevel');
    if(setLevelElement.style.display != 'none'){
        var setLevelTo = parseInt(setLevelElement.value);
        setDifficultyLevel(setLevelTo);
    }

    createTrack();

		theTimer = window.setInterval(playGame, millisecondsBetweenScrolls);
		startGame=false;
	}
}

function createTrack(){

    calculateFontSizeBasedOnCanvas()

    track = new Array();
    for(var trackLine=0;trackLine<maxTrackLines;trackLine++){
        track.push(getTrackLine(posOfLeftOfTrack, widthOfTrack, maxWidthOfArena));
    }
}

function calculateFontSizeBasedOnCanvas(){
    var canvas = document.getElementById("gamedisplay");
    if(canvas.getContext){
        var context2d = canvas.getContext("2d");

        // calculate a fontsize that fits canvas
        fontSize = Math.floor(context2d.canvas.height/maxTrackLines);
        context2d.font = fontSize + "px courier";
        while((context2d.measureText("*").width * maxWidthOfArena)>context2d.canvas.width){
          fontSize--;
          context2d.font = fontSize + "px courier";
        }
        fontWidth = context2d.measureText("*").width;
        // how many lines fit into the canvas?
        while(maxTrackLines*fontSize<context2d.canvas.height){
          maxTrackLines++;
        }
        maxTrackLines--;
    }

    carLine = Math.floor((maxTrackLines/2)/2);

}

function drawTrack(){
  var canvas = document.getElementById("gamedisplay");

  if(canvas.getContext){
      var context2d = canvas.getContext("2d");

      context2d.clearRect(0,0,context2d.canvas.width, context2d.canvas.height);
      context2d.fillStyle = "#FFFFFF";
      context2d.fillRect(0,0,context2d.canvas.width, context2d.canvas.height);
      context2d.fillStyle = "#000000";
      
      for(var yline=0;yline<maxTrackLines;yline++){
          context2d.fillText(track[yline],0,yline*fontSize);
      }
  }

}

function drawCar(carLine,carPosition){
    var canvas = document.getElementById("gamedisplay");

    if(canvas.getContext){
        var context2d = canvas.getContext("2d");
        context2d.fillStyle = "#000000";
        context2d.fillText("V",carPosition*fontWidth,carLine*fontSize);
    }
}

function drawCrashedCar(carLine,carPosition){
    var canvas = document.getElementById("gamedisplay");

    if(canvas.getContext){
        var context2d = canvas.getContext("2d");
        context2d.fillStyle = "#000000";
        context2d.fillText("X",carPosition*fontWidth,carLine*fontSize);
    }
}

function scrollTrack(nextLine){
    track.shift();
    track.push(nextLine);
}



function playGame(){

  // calculate points etc.
  distanceTravelled++;
  points=distanceTravelled*10;
  changeSpanText('thePoints', points);
  changeSpanText('theSpeed', millisecondsBetweenScrolls/500);

  scroll()


  // change track width
  changeTrackWidth();


  displayTheTrackToTheConsole();
  adjustTheTrackForRoadWeaving();

	if(hasCrashed){
    endGame();
	}
}

function scroll(){
    // change speed
    distanceToNextSpeedChange--;
  if(distanceToNextSpeedChange<0){
      millisecondsBetweenScrolls-=currentAcceleration;

      if(millisecondsBetweenScrolls<maxSpeedMillis){
        millisecondsBetweenScrolls=maxSpeedMillis;
      }

      window.clearInterval(theTimer);
      theTimer = window.setInterval(playGame, millisecondsBetweenScrolls);

      changeSpeed();

  }
}

function changeSpeed(){

  if(distanceTravelled<100){
    if(distanceToNextSpeedChange<0){
      distanceToNextSpeedChange=5;
      currentAcceleration=20;
      trackWidthChangeEvery=2;
    }
    if(widthOfTrack<12){
        widthOfTrack=12;
      }
  }

  if(distanceTravelled<200){
    if(distanceToNextSpeedChange<0){
      distanceToNextSpeedChange=3;
      currentAcceleration=50;
      trackWidthChangeEvery=15;
    }

      if(widthOfTrack<10){
        widthOfTrack=10;
      }
  }

  if(distanceTravelled<300){
    if(distanceToNextSpeedChange<0){
      distanceToNextSpeedChange=3;
      currentAcceleration=30;
    }
    if(widthOfTrack<7){
        widthOfTrack=7;
      }
  }


  if(distanceTravelled<400){
    currentAcceleration=50;
    maxSpeedMillis-=10;
        if(maxSpeedMillis<150){
          maxSpeedMillis=150;
        }
  }

  if(distanceTravelled<500){
    if(widthOfTrack<5){
        widthOfTrack=5;
      }
  }
}


/*
function changeTrackWidth(){
  if(distanceTravelled%trackWidthChangeModulus==0){
      widthOfTrack-=getRandomInt(0, maxWidthOfTrackIncrement);
      if(widthOfTrack < minWidthOfTrack){
        widthOfTrack = minWidthOfTrack;
      }
  }
}
*/

function changeTrackWidth(){
  if(distanceTravelled%trackWidthChangeEvery==0){
      widthOfTrack-=1;
      if(widthOfTrack < minWidthOfTrack){
        widthOfTrack = minWidthOfTrack;
        // track lowest - make it faster instead
        maxSpeedMillis-=10;
        if(maxSpeedMillis<10){
          maxSpeedMillis=10;
        }
      }
  }
}

function setDifficultyLevel(theLevel){

  var levels =[{s:500,w:40},
               {s:450,w:35},
               {s:400,w:30},
               {s:350,w:25},
               {s:300,w:20},
               {s:250,w:15},
               {s:200,w:10}
            ];

  var setToLevel=0;
  if(theLevel>=0 && theLevel<levels.length){
    setToLevel=theLevel;
  }

  if(theLevel>=levels.length){
    setToLevel=levels.length-1;
  }

  millisecondsBetweenScrolls=levels[setToLevel].s;
  widthOfTrack=levels[setToLevel].w;
  carPosition = posOfLeftOfTrack + Math.floor(widthOfTrack/2);
}

function endGame(){
  showInfo("!!GAME OVER!! You Crashed! You Scored " + points);
  startGame=false;
  window.clearInterval(theTimer);
  document.getElementById('instructions').style.display = 'block';
  //document.getElementById('gameboard').style.display = 'none';
  theTimer = window.setInterval(instructions, millisecondsBetweenScrolls);

}



function advanceCar(){
  drawCar(carLine,carPosition);
}

function displayTheTrackToTheConsole(){

  

  var nextLine = getTrackLine(posOfLeftOfTrack, widthOfTrack, maxWidthOfArena);

  scrollTrack(nextLine);

  drawTrack();

  advanceCar();
  

  // get track from array
  var trackDisplay = track[carLine];

  var trackArray = trackDisplay.split("");
  var carSpace = trackArray[carPosition];

  // use array above instead of string manipulationg - seems simpler
  //var leftOfTrack = trackDisplay.substring(0,carPosition);
  //var carSpace = trackDisplay.substr(carPosition, 1);
  //var rightOfTrack = trackDisplay.slice(carPosition);

  if(checkForCrash(carSpace)){
    carDisplay="X";
    drawCrashedCar(carLine, carPosition);
  }

  // add car to the track
  //trackDisplay = leftOfTrack + carDisplay + rightOfTrack;
  trackArray[carPosition] = carDisplay;

  trackDisplay = trackArray.join("");

  console.log(trackDisplay);
  

}

function centerCar(){
  carPosition = track[carLine].indexOf(" ")+
                Math.floor(
                    (track[carLine].lastIndexOf(" ")-track[carLine].indexOf(" ")
                    )/2);
}

function checkForCrash(carSpace){
    //if(carSpace != " "){  // are you on a road?
  if(carSpace == "*"){ // have you hit a wall?

    lives--;
    if(lives<1){
      // deaded
      hasCrashed=true;
    }else{
      // second chance
      showInfo("OUCH - be careful - lives left: " + lives);
      millisecondsBetweenScrolls*=3;
      if(millisecondsBetweenScrolls>500){
        millisecondsBetweenScrolls=500;
      }
      centerCar()
    }

    
    return true;
  }
  return false;
}


function adjustTheTrackForRoadWeaving(){
  var leftNudge = getRandomInt(-1, 1);

  posOfLeftOfTrack += leftNudge;
  if(posOfLeftOfTrack<1){
    posOfLeftOfTrack=1;
  }
  if((posOfLeftOfTrack+widthOfTrack) > maxWidthOfArena){
    posOfLeftOfTrack = maxWidthOfArena - widthOfTrack - 1;
  }
}

function setValuesToStartingValues(){

   posOfLeftOfTrack=1;
   maxWidthOfArena=60;
   widthOfTrack=58;
   minWidthOfTrack=4;
   trackWidthChangeEvery=5;
   currentAcceleration=50;
   lives = 3;

   points=0;
   startGame = false;
   trackString = " - ";
   carDisplay = "V";
   hasCrashed = false;
   millisecondsBetweenScrolls=500;
   distanceTravelled=0;
   distanceToNextSpeedChange=5;
   speedChanges=0;
   maxSpeedMillis=100;
   maxWidthOfTrackIncrement=3;

   maxTrackLines=20;

   if(promptForValues){
      var promptedValue = window.prompt("Enter Max Arena Width",maxWidthOfArena);
      if(promptedValue!=null){
        maxWidthOfArena = parseInt(promptedValue);
      }

      promptedValue = window.prompt("Enter Start Width of Track",widthOfTrack);
      if(promptedValue!=null){
        widthOfTrack = parseInt(promptedValue);
      }

      promptedValue = window.prompt("Enter initial milliseconds between scrolls (speed - high is slower)",millisecondsBetweenScrolls);
      if(promptedValue!=null){
        millisecondsBetweenScrolls = parseInt(millisecondsBetweenScrolls);
      }

      promptForValues=false;
   }

   posOfLeftOfTrack = getRandomInt(1,(maxWidthOfArena/2)-(widthOfTrack/2)-1);
   carPosition = posOfLeftOfTrack + Math.floor(widthOfTrack/2);

}


  var distanceTravelled, distanceToNextSpeedChange, speedChanges, fontSize, fontWidth;
  var carLine; // car position line display
  var posOfLeftOfTrack=1;
  var maxWidthOfArena=60;
  var widthOfTrack=maxWidthOfArena-6;
  var minWidthOfTrack=8;
  var trackWidthChangeEvery=5;
  var currentAcceleration=50;
  var maxTrackLines=20;
  var lives = 3;

  var carPosition = posOfLeftOfTrack + (widthOfTrack/2);
  var points=0;
  var startGame = false;
  var promptForValues=false;
  // build a string and display to the console
  // randomly shift track left or right

  var trackString = " - ";

  var carDisplay = "V";
  var hasCrashed = false;

  // initially show the instructions
  var millisecondsBetweenScrolls=500;
  var maxSpeedMillis=50;
  var theTimer = window.setInterval(instructions, millisecondsBetweenScrolls);
  var maxWidthOfTrackIncrement=3;



</script>

</head>
<body>

<h1>Canvas Driver</h1>

  <div id="instructions">
  	<h1>Instructions</h1>
  	<p>Use left and Right to keep your car 'V' on the track.
       Hit a wall '*' and you will explode "X". Each Time you
       explode you lose a life. You only have 3 lives.</p>
  	<h2>Press space to start game</h2>
    <!-- prototype for set start level difficulty -->
    <input id="setLevel" style="display:none" value="1" />
  </div>

  <!-- todo: add some defaults and debugging here to make tweaking gameplay easier -->

  <div id="gameboard">
  	<h1>Points: <span id='thePoints'></span></h1>
    <h1>Speed: <span id='theSpeed'></span></h1>
    <canvas id="gamedisplay" width="500" height="500"></canvas>
  </div>

  <h1>Info: <span id='info'></span></h1>

</body>
</html>
